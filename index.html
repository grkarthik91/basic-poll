<!DOCTYPE html>
<html>
<head>
  <title>Poll with Firebase - Max 3 per date & per user</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <div id="loginDiv">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email" /><br><br>
    <input type="password" id="password" placeholder="Password" /><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>

  <div id="pollDiv" style="display:none;">
    <h2>Welcome <span id="userEmail"></span>! Choose your dates (up to 3 total):</h2>

    <p style="font-style: italic; color: #555;">
      1. Please enter your name. <br>
      2. Please select a date and click Submit. <br>
      3. Then choose the next date and click Submit. <br>
      4. Choose and the third date and cick Submit. <br>
      5. After 3 date selections, no more date selections allowed. <br>
      ** You donâ€™t have to choose all your dates at once. You can select some now and log in later to complete your remaining choices.
    </p>

    <div id="nameInputDiv">
      <label>Name: <input type="text" id="name" placeholder="Your name" required/></label><br><br>
    </div>
    <div id="nameDisplayDiv" style="display:none;">
      <p>Name: <span id="savedName"></span></p>
    </div>

    <label>Pick a date:</label><br>
    <select id="dateSelect">
      <option value="">--Select a date--</option>
    </select><br><br>

    <button onclick="submitPoll()">Submit</button>
    <button onclick="logout()">Logout</button>

    <p id="pollMsg"></p>


    <h3>Your selected dates so far:</h3>
    <ul id="userSelections"></ul>

    <hr>

    <h3>All Poll Responses:</h3>
    <ul id="allResponsesList"></ul>
  </div>

  <script>
    // Firebase config - replace with your own
    const firebaseConfig = {
      apiKey: "AIzaSyDOR1u3K67olwMhXWqmIgo-tJ6l8m8T5B4",
      authDomain: "lab-talk-dates-poll.firebaseapp.com",
      projectId: "lab-talk-dates-poll",
      storageBucket: "lab-talk-dates-poll.firebasestorage.app",
      messagingSenderId: "332022604058",
      appId: "1:332022604058:web:86cc9723ecd910e43d0ca3"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    const maxGlobalSelectionsPerDate = 3;
    const maxUserSelections = 3;

    const allDates = [
      "22-Aug-2025",
      "29-Aug-2025",
      "12-Sep-2025",
      "19-Sep-2025",
      "26-Sep-2025",
      "03-Oct-2025",
      "10-Oct-2025",
      "17-Oct-2025",
      "07-Nov-2025",
      "14-Nov-2025",
      "21-Nov-2025",
      "28-Nov-2025",
      "05-Dec-2025",
      "19-Dec-2025",
      "26-Dec-2025",
      "02-Jan-2026",
      "09-Jan-2026",
      "16-Jan-2026",
      "23-Jan-2026",
      "06-Feb-2026",
      "13-Feb-2026",
      "20-Feb-2026",
      "27-Feb-2026",
      "06-Mar-2026",
      "13-Mar-2026",
      "20-Mar-2026",
      "27-Mar-2026",
      "03-Apr-2026",
      "10-Apr-2026",
      "17-Apr-2026",
      "24-Apr-2026",
      "01-May-2026",
      "08-May-2026",
      "15-May-2026",
      "22-May-2026",
      "29-May-2026",
      "05-Jun-2026",
      "12-Jun-2026",
      "19-Jun-2026",
      "26-Jun-2026",
    ];

    const loginDiv = document.getElementById('loginDiv');
    const pollDiv = document.getElementById('pollDiv');
    const userEmailSpan = document.getElementById('userEmail');
    const loginMsg = document.getElementById('loginMsg');
    const pollMsg = document.getElementById('pollMsg');
    const dateSelect = document.getElementById('dateSelect');
    const userSelectionsUl = document.getElementById('userSelections');
    const allResponsesList = document.getElementById('allResponsesList');

    const nameInputDiv = document.getElementById('nameInputDiv');
    const nameDisplayDiv = document.getElementById('nameDisplayDiv');
    const savedNameSpan = document.getElementById('savedName');

    let currentUser = null;
    let userSelections = [];

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        loginDiv.style.display = 'none';
        pollDiv.style.display = 'block';
        userEmailSpan.textContent = user.email;
        pollMsg.textContent = '';

        await loadUserName();

        // Show or hide name input/display depending on localStorage
        const savedName = document.getElementById('name');
        
        if (savedName.value.trim() !== "") {
          nameInputDiv.style.display = 'none';
          nameDisplayDiv.style.display = 'block';
          savedNameSpan.textContent = savedName.value.trim();
        } else {
          nameInputDiv.style.display = 'block';
          nameDisplayDiv.style.display = 'none';
          document.getElementById('name').value = '';
        }

        await loadUserSelections();
        await loadAvailableDates();
        await loadAllResponses();
      } else {
        currentUser = null;
        loginDiv.style.display = 'block';
        pollDiv.style.display = 'none';
        loginMsg.textContent = '';
      }
    });

    async function login() {
      loginMsg.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch(e) {
        loginMsg.textContent = e.message;
      }
    }

    async function logout() {
      await auth.signOut();
    }

    async function loadUserName() {
      const single_snapshot = await db.collection('responses')
        .where('userEmail', '==', currentUser.email)
        .limit(1)
        .get();

      if (!single_snapshot.empty) {
        const doc = single_snapshot.docs[0]; // Get the first document
        const data = doc.data();
        document.getElementById('name').value = data.name;
      } else {
        document.getElementById('name').value = "";
      }
    }

    async function loadUserSelections() {
      userSelections = [];
      userSelectionsUl.innerHTML = '';

      const snapshot = await db.collection('responses')
        .where('userEmail', '==', currentUser.email)
        .get();

      snapshot.forEach(doc => {
        const data = doc.data();
        userSelections.push(data.date);
      });

      updateUserSelectionsUI();
    }

    function updateUserSelectionsUI() {
      userSelectionsUl.innerHTML = '';
      if (userSelections.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'You have not selected any dates yet.';
        userSelectionsUl.appendChild(li);
        return;
      }
      userSelections.forEach(date => {
        const li = document.createElement('li');
        li.textContent = date;
        userSelectionsUl.appendChild(li);
      });
    }

    async function loadAvailableDates() {
      const counts = {};
      allDates.forEach(d => counts[d] = 0);

      const snapshot = await db.collection('responses').get();

      snapshot.forEach(doc => {
        const data = doc.data();
        if (counts[data.date] !== undefined) {
          counts[data.date]++;
        }
      });

      let availableDates = allDates.filter(d => counts[d] < maxGlobalSelectionsPerDate);

      availableDates = availableDates.filter(d => !userSelections.includes(d));

      if (userSelections.length >= maxUserSelections) {
        dateSelect.innerHTML = '<option>You have selected max allowed dates.</option>';
        dateSelect.disabled = true;
        document.querySelector('button[onclick="submitPoll()"]').disabled = true;
        return;
      } else {
        dateSelect.disabled = false;
        document.querySelector('button[onclick="submitPoll()"]').disabled = false;
      }

      dateSelect.innerHTML = '<option value="">--Select a date--</option>';
      availableDates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateSelect.appendChild(option);
      });

      if (availableDates.length === 0) {
        dateSelect.innerHTML = '<option>No dates available at the moment.</option>';
        dateSelect.disabled = true;
        document.querySelector('button[onclick="submitPoll()"]').disabled = true;
      }
    }

    async function submitPoll() {
      pollMsg.style.color = 'red';
      pollMsg.textContent = '';
      
      name = document.getElementById('name').value.trim();
      if (!name) {
        pollMsg.textContent = 'Please enter your name.';
        return;
      }

      nameInputDiv.style.display = 'none';
      nameDisplayDiv.style.display = 'block';
      savedNameSpan.textContent = name;

      const selectedDate = dateSelect.value;

      if (!selectedDate) {
        pollMsg.textContent = 'Please select a date.';
        return;
      }

      if (userSelections.length >= maxUserSelections) {
        pollMsg.textContent = `You can only select up to ${maxUserSelections} dates.`;
        return;
      }

      const globalSnapshot = await db.collection('responses')
        .where('date', '==', selectedDate)
        .get();

      if (globalSnapshot.size >= maxGlobalSelectionsPerDate) {
        pollMsg.textContent = 'Sorry, that date is no longer available.';
        await loadAvailableDates();
        return;
      }

      if (userSelections.includes(selectedDate)) {
        pollMsg.textContent = 'You already selected this date.';
        return;
      }

      try {
        await db.collection('responses').add({
          name: name,
          date: selectedDate,
          userEmail: currentUser.email,
          timestamp: new Date()
        });

        userSelections.push(selectedDate);
        updateUserSelectionsUI();
        await loadAvailableDates();
        await loadAllResponses();

        pollMsg.style.color = 'green';
        pollMsg.textContent = `Thanks ${name}! You selected ${selectedDate}.`;

        dateSelect.value = '';
      } catch (err) {
        pollMsg.textContent = 'Error submitting: ' + err.message;
      }
    }

    async function loadAllResponses() {
      allResponsesList.innerHTML = '';

      const snapshot = await db.collection('responses')
        .orderBy('timestamp', 'desc')
        .get();

      if (snapshot.empty) {
        allResponsesList.innerHTML = '<li>No poll responses yet.</li>';
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement('li');
        li.textContent = `Name: ${data.name}, Date: ${data.date}, User: ${data.userEmail}`;
        allResponsesList.appendChild(li);
      });
    }
  </script>

</body>
</html>
